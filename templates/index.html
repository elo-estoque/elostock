<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SmartStock AI 2.0</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', system-ui, sans-serif; }
        .content-box { background: white; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); padding: 2.5rem; }
        .card-custom { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); transition: transform 0.2s; }
        .card-custom:hover { transform: translateY(-2px); }
        .badge-stock { font-size: 0.9em; padding: 0.5em 0.8em; }
    </style>
</head>
<body>

    {% if view_mode == 'login' %}
    <div class="container d-flex align-items-center justify-content-center" style="min-height: 100vh;">
        <div class="content-box text-center" style="width: 100%; max-width: 400px;">
            <div class="mb-4">
                <i class="bi bi-box-seam text-primary" style="font-size: 3rem;"></i>
            </div>
            <h3 class="fw-bold mb-4 text-dark">SmartStock <span class="text-primary">AI</span></h3>
            
            {% if erro %}
                <div class="alert alert-danger py-2 small">{{ erro }}</div>
            {% endif %}
            
            <form method="POST">
                <div class="form-floating mb-3 text-start">
                    <input type="email" name="login_email" class="form-control" id="floatingInput" placeholder="name@example.com" required>
                    <label for="floatingInput">E-mail Directus</label>
                </div>
                <div class="form-floating mb-4 text-start">
                    <input type="password" name="login_password" class="form-control" id="floatingPassword" placeholder="Password" required>
                    <label for="floatingPassword">Senha</label>
                </div>
                <button type="submit" class="btn btn-primary w-100 py-3 fw-bold rounded-3">ENTRAR</button>
            </form>
            <p class="mt-4 text-muted small">Integrado com Gemini & Directus</p>
        </div>
    </div>

    {% elif view_mode == 'dashboard' %}
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#"><i class="bi bi-box-seam me-2"></i>SmartStock</a>
            <div class="d-flex align-items-center text-white">
                <span class="me-3 small opacity-75 d-none d-md-inline">Olá, {{ user }}</span>
                <a href="/logout" class="btn btn-outline-light btn-sm rounded-pill px-3">Sair</a>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold text-secondary"><i class="bi bi-cart me-2"></i>Almoxarifado</h5>
                </div>
                <div class="card card-custom h-100">
                    <div class="list-group list-group-flush rounded-3">
                        {% for p in produtos %}
                        {% set is_low = p.quantidade <= (p.estoque_minimo or 0) %}
                        
                        <div class="list-group-item py-3 d-flex justify-content-between align-items-center {{ 'bg-danger-subtle' if is_low else '' }}">
                            <div>
                                <h6 class="mb-1 fw-bold">{{ p.nome }}</h6>
                                <small class="text-muted"><i class="bi bi-geo-alt"></i> {{ p.localizacao }}</small>
                                {% if is_low %}
                                    <span class="badge bg-danger ms-2">Crítico</span>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                <span class="d-block fw-bold h5 mb-0">{{ p.quantidade }}</span>
                                <a href="/acao/produto/{{ p.id }}" class="btn btn-sm btn-link text-decoration-none p-0">Retirar</a>
                            </div>
                        </div>
                        {% else %}
                        <div class="p-4 text-center text-muted">Nenhum produto encontrado.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold text-secondary"><i class="bi bi-tags me-2"></i>Amostras & Showroom</h5>
                </div>
                <div class="card card-custom h-100">
                    <div class="list-group list-group-flush rounded-3">
                        {% for a in amostras %}
                        <div class="list-group-item py-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="mb-0 fw-bold">{{ a.nome }}</h6>
                                    <small class="text-muted" style="font-size: 0.75rem;">PAT: {{ a.codigo_patrimonio or 'S/N' }}</small>
                                </div>
                                {% if a.status == 'DISPONIVEL' %}
                                    <span class="badge bg-success bg-opacity-10 text-success border border-success">Disponível</span>
                                {% else %}
                                    <span class="badge bg-warning bg-opacity-10 text-warning border border-warning text-dark">Em Rua</span>
                                {% endif %}
                            </div>
                            
                            {% if a.status == 'EM_RUA' %}
                                <div class="alert alert-light border p-2 mb-2 small">
                                    <i class="bi bi-person-circle me-1"></i> <strong>{{ a.vendedor_responsavel }}</strong><br>
                                    <span class="text-muted">Previsão: {{ a.data_prevista_retorno.strftime('%d/%m') if a.data_prevista_retorno else '?' }}</span>
                                </div>
                            {% endif %}
                            
                            <a href="/acao/amostra/{{ a.id }}" class="btn btn-sm btn-outline-dark w-100 rounded-pill mt-1">Gerenciar</a>
                        </div>
                        {% else %}
                        <div class="p-4 text-center text-muted">Nenhuma amostra cadastrada.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% elif view_mode == 'acao' %}
    <div class="container d-flex align-items-center justify-content-center" style="min-height: 100vh;">
        <div class="content-box text-center shadow-lg" style="width: 100%; max-width: 450px;">
            
            {% if msg %}
                <div class="mb-4 text-success">
                    <i class="bi bi-check-circle-fill" style="font-size: 4rem;"></i>
                </div>
                <h4 class="fw-bold mb-3">Sucesso!</h4>
                <p class="text-muted mb-4">{{ msg }}</p>
                <a href="/dashboard" class="btn btn-dark w-100 py-3 rounded-pill fw-bold">Voltar ao Painel</a>
            {% else %}
            
                <div class="mb-3">
                    <span class="badge bg-secondary text-uppercase ls-1">Gerenciando</span>
                </div>
                <h2 class="fw-bold mb-4">{{ item.nome }}</h2>

                <form method="POST">
                    {% if tipo == 'produto' %}
                        <div class="card bg-light border-0 mb-4">
                            <div class="card-body">
                                <h6 class="text-muted text-uppercase small">Estoque Atual</h6>
                                <div class="display-4 fw-bold text-primary">{{ item.quantidade }}</div>
                            </div>
                        </div>
                        
                        <label class="form-label fw-bold">Quantidade a retirar</label>
                        <input type="number" name="qtd" class="form-control form-control-lg text-center mb-4" value="1" min="1" max="{{ item.quantidade }}">
                        
                        <button type="submit" class="btn btn-primary w-100 btn-lg py-3 rounded-3 fw-bold">
                            <i class="bi bi-box-arrow-down me-2"></i>CONFIRMAR RETIRADA
                        </button>
                    
                    {% else %}
                        <div class="mb-4 text-start">
                            {% if item.status == 'DISPONIVEL' %}
                                <div class="alert alert-success border-0 d-flex align-items-center">
                                    <i class="bi bi-check-lg fs-3 me-3"></i>
                                    <div>
                                        <strong>Item na Estante</strong><br>
                                        <small>Pronto para empréstimo</small>
                                    </div>
                                </div>
                                <input type="hidden" name="acao_amostra" value="retirar">
                                <button type="submit" class="btn btn-warning w-100 btn-lg py-3 text-dark fw-bold rounded-3">
                                    REGISTRAR SAÍDA
                                </button>
                            {% else %}
                                <div class="alert alert-warning border-0 text-dark">
                                    <small class="text-uppercase text-muted fw-bold">Responsável Atual</small>
                                    <div class="fw-bold fs-5 mb-1">{{ item.vendedor_responsavel }}</div>
                                    <small>Retirado em: {{ item.data_saida.strftime('%d/%m') if item.data_saida else '-' }}</small>
                                </div>
                                <input type="hidden" name="acao_amostra" value="devolver">
                                <button type="submit" class="btn btn-success w-100 btn-lg py-3 fw-bold rounded-3">
                                    <i class="bi bi-arrow-return-left me-2"></i>REGISTRAR DEVOLUÇÃO
                                </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </form>

                <a href="/dashboard" class="btn btn-link text-secondary mt-3 text-decoration-none">Cancelar e Voltar</a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
